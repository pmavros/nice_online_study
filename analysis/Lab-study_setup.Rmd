---
title: "NICE Online"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, warning=FALSE, message=FALSE}
options(digits = 3)

cache <- FALSE
fig.width <- see::golden_ratio(7)
fig.height <- 7

knitr::opts_chunk$set(
  collapse = TRUE,
  dpi = 450,
  fig.path = "./figures/",
  fig.width = fig.width,
  fig.height = fig.height
)
```

## Data

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggdist)
library(ggside)
library(easystats)
library(patchwork)
```


```{r message=FALSE, warning=FALSE}

df <- read.csv('../../NICE_Group-Folder/9_analysis/Online Study/data/data_pruned_for_analysis_2022-09-14.csv') |> 
  mutate(Typology = fct_relevel(primary_category, "urban", "green"))

length(unique(df$Participant))

```

## Dataset Selection

### Videos Data
Calculate the number of views and average score for each video (stimulus).
```{r message=FALSE, warning=FALSE}
df_stim <- df |>
  group_by(Video, Typology) |>
  summarize(views = n(),
            Video_duration = first(Video_Time),
            name_df = first(name_df),
            Perceived_Crowdedness = mean(Crowdedness, na.rm = TRUE),
            Pedestrian_flow = mean(mean_pedcounts, na.rm = TRUE),
            Beauty = mean(Beauty, na.rm = TRUE),
            Restoration = mean(Restoration, na.rm = TRUE),
            Presence = mean(Presence, na.rm = TRUE),
            Willingness_to_walk = mean(Attractiveness, na.rm = TRUE),
            Structure = mean(Structure, na.rm = TRUE),
            Scenery = mean(Scenery, na.rm = TRUE),
            Interest = mean(Interest, na.rm = TRUE),
            Width = mean(Width, na.rm = TRUE),
            Familiarity = mean(Familiarity, na.rm = TRUE),
            Positivity = mean(Positivity, na.rm = TRUE),
            Excitement = mean(Excitement, na.rm = TRUE)) |>
  ungroup()

nrow(df_stim)

```

# Each video has been seen on average by `r mean(df_stim$n)` participants (SD = `r sd(df_stim$n)`, range = [`r min(df_stim$n)`, `r max(df_stim$n)`]) 

### Dimension Reduction

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# data <- df |>
# select(Crowdedness, Beauty, Restoration, Presence, Attractiveness, Structure, Scenery, Interest, Width, Familiarity, Positivity, Excitement)
# 
# data <- df_stim |>
#   select(-Video, -n, -Typology)
```

## Remove stimuli

Some videos need to be removed (e.g. less than 30 seconds, low resolution).

```{r}

data_urban <- df_stim %>% 
  rowid_to_column() %>% 
  filter(Typology == "urban") %>% 
  filter(Video_duration >= 30) %>% 
  filter(str_detect(tolower(name_df), "vancouver", negate = TRUE)) %>% 
  select(rowid, Perceived_Crowdedness, Beauty) 

data_green <- df_stim %>% 
  rowid_to_column() %>% 
  filter(Typology == "green") %>% 
  filter(Video_duration >= 30) %>% 
  filter(str_detect(tolower(name_df), "vancouver", negate = TRUE)) %>% 
  select(rowid, Perceived_Crowdedness, Beauty) 

nrow(data_urban)
nrow(data_green)

```

## Stimuli clustering
Cluster objects

```{r, warning=FALSE, message=FALSE, eval=FALSE}
data = data_urban
find_most_dissimilar <- function (data, k_clusters = 50){
  
  d <- dist(data %>% select(-rowid), diag = TRUE, upper=TRUE)
  plot(hclust(d))
  
  # split in k clusters, where k corresponds to the amount of stimuli we want at the new study
  clusters <- cutree(hclust(d), k = k_clusters)
  hist(clusters)
  table(clusters)
  
  ## Calculate dissimilarity matrix
  ## combine results, take sum to aggregate dissimilarity

  dissimilarity_clusters <- data.frame(rowid=data %>% select(rowid),
                  cluster=clusters,
                  dissimilarity=rowSums(as.matrix(d)))
  dissimilarity_clusters

  # order, lowest overall dissimilarity will be first
  dissimilarity_clusters <- dissimilarity_clusters[order(dissimilarity_clusters$dissimilarity, decreasing = T), ]
  
  # split object
  reslist <- split(dissimilarity_clusters, f = dissimilarity_clusters$cluster)
  reslist
  
  ## returns idÂ´s with highest overall dissimilarity
  redundant <- sapply(reslist, function(x) {
    if(nrow(x) > 1) {
      return(head(x, n=1)$rowid)
    } else {
      # return(NA)
      return(head(x, n=1)$rowid)
    }
   })
  
  redundant <- redundant[!is.na(redundant)]
  length(redundant)
  redundant
  
  final_set <- dissimilarity_clusters %>%
    filter(rowid %in% unname(redundant))
  
  return(final_set)
}


```



```{r}

video_data <- read_csv("../../NICE_Group-Folder/3_materials/stimuli_scripts/final_set_with_testing_groups_typology_220914.csv")

final_set_urban <- find_most_dissimilar(data_urban, 35)
final_set_green<- find_most_dissimilar(data_green, 15)

final_set <- final_set_urban %>% 
  bind_rows(final_set_green)

final_set <- df_stim %>% 
  rowid_to_column() %>% 
  left_join(final_set) %>% 
  # filter(!is.na(cluster)) %>% 
  # filter(rowid %in% unname(redundant)) %>% 
  left_join(video_data, by = c("Video" = "link" ))

  
final_set <- final_set %>%
  select(name_df_keep, cluster, dissimilarity, Typology, Perceived_Crowdedness, Pedestrian_flow, Beauty, Structure, Interest)

final_set
```

## inspect final set
```{r}
final_set %>% filter(!is.na(cluster)) %>% select(name_df_keep) %>% print(n = 100)
```


```{r}

final_set %>% 
  filter(!is.na(cluster)) %>% 
  count(Typology)

```
[1] "Seoul Walking Tour  ILSAN LAKE PARK  Beautiful Korea"                   
[2] "Walking in LONDON  England UK  St Pauls to Big Ben 2019    6"           
[3] "Walking Through the Forest at Kakum National Park  Ghana Nov 2018 Tour1"
[4] "Bukit Timah Green Corridor Walk  Singapore Scene  Singapore"            
[5] "Virtual Hike in New York State  Autumn Walk 1"   

```{r}

final_set %>% 
  # filter(Typology != "green") %>% 
  arrange(Beauty) %>% 
  ggplot(aes(Beauty, Perceived_Crowdedness, shape = Typology, colour = !is.na(cluster))) +
  geom_point() +
  theme_blackboard() +
  ggdist::geom_slab() +
  ggside::geom_xsidedensity(adjust = 2) +
  ggside::geom_ysidedensity(adjust = 2)

```

```{r}
final_set %>% 
    filter(!is.na(cluster)) %>%
    arrange(Beauty) %>% 
    ggplot(aes(Perceived_Crowdedness, colour = Typology, shape = Typology)) +
    theme_blackboard() +
    geom_density()
```

```{r}
library("ggimage")

final_set %>% 
  # filter(Typology != "green") %>% 
  arrange(Beauty) %>% 
  ggplot(aes(Beauty, Perceived_Crowdedness, colour = Typology, shape = Typology)) +
  geom_point() +
  theme_blackboard() 
```

```{r}
img <- list.files(path = "../../3_materials/stimuli/frame/",
                  pattern="png", full.names=TRUE)
img

d <- data.frame(x = rnorm(4),
                y = rnorm(4),
                image = sample(img, size=4, replace = TRUE)
                )
d
ggplot(d, aes(x, y)) + geom_image(aes(image=image), size=.5)

```

```{r}
video_data %>% 
  filter(name_df_keep == "Walking in LONDON  England (UK) - Soho - 4K 60fps (UHD) (1080p)mp4_12")
```


