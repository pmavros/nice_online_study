---
title: "NICE Online"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

# Setup

```{r, echo = FALSE, warning=FALSE, message=FALSE}
options(digits = 3)

cache <- FALSE
fig.width <- see::golden_ratio(7)
fig.height <- 7

knitr::opts_chunk$set(
  collapse = TRUE,
  dpi = 450,
  fig.path = "./figures/",
  fig.width = fig.width,
  fig.height = fig.height
)

# palette
col_urban = "#FFC125" # "#E1BE6A"
col_green = "#40B0A6"
```

## Libraries used
Load libraries necessary to run the script.
```{r}
library(tidyverse) # general
library(ggdist) # plot distributions
library(ggside) # plot distributions on the plot margins
library(easystats) # estimate and process statistical models
library(patchwork) # combine multiple plots
library(modelsummary) # for tables

```


## Reusable functions
### Plot distributions
```{r fig.height=fig.height*2, message=FALSE, warning=FALSE, cache=FALSE}
plot_distributions <- function(df, col) {
  p1 <- df[c("Participant", col)] |>
    group_by(Participant) |>
    mean_qi(na.rm = TRUE) |>
    rename("x" = all_of(col)) |>
    mutate(Participant = fct_reorder(Participant, x)) |>
    ggplot(aes(x = x, y = Participant)) +
    ggdist::geom_pointinterval(aes(color = Participant, xmin = .lower, xmax = .upper), interval_size_range = c(0.03, 0.03), fatten_point = 1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_color_material_d(guide = "none") +
    theme_modern() +
    theme(axis.text.y = element_blank(), axis.title.x = element_blank()) +
    labs(y = "Participants") +
    ggside::geom_xsidedensity(aes(y = stat(density)), fill = "#9C27B0", color = NA) +
    ggside::geom_xsidedensity(data = df, aes_string(x = col, y = "stat(density)"), fill = "black", color = NA, alpha = 0.2) +
    ggside::theme_ggside_void()

  p2 <- df[c("Video", col)] |>
    group_by(Video) |>
    mean_qi(na.rm = TRUE) |>
    rename("x" = all_of(col)) |>
    mutate(Video = fct_reorder(Video, x)) |>
    ggplot(aes(x = x, y = Video)) +
    ggdist::geom_pointinterval(aes(color = Video, xmin = .lower, xmax = .upper), , interval_size_range = c(0.03, 0.03), fatten_point = 1) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_color_viridis_d(guide = "none") +
    theme_modern() +
    theme(axis.text.y = element_blank(), axis.title.x = element_blank()) +
    labs(y = "Videos") +
    ggside::geom_xsidedensity(aes(y = stat(density)), fill = col_green, color = NA) +
    ggside::geom_xsidedensity(data = df, aes_string(x = col, y = "stat(density)"), fill = "black", color = NA, alpha = 0.2) +
    ggside::theme_ggside_void()

  wrap_elements(
    p1 + p2 +
      plot_annotation(
        title = col,
        theme = theme(plot.title = element_text(hjust = 0.5, face = "bold"))
      )
  )
}
```

# Analysis
## Load data

```{r message=FALSE, warning=FALSE}
# path <-
  # df <- read.csv("C:/Dropbox/RECHERCHE/Projects/NICE_Group-Folder/9_analysis/Online Study/data/data_pruned_for_analysis_2022-09-14.csv") |>
df <- read.csv("~/Dropbox/FCL_Panos/01_Projects/NICE/NICE_Group-Folder/9_analysis/Online Study/data/data_pruned_for_analysis_2022-09-14.csv") |>
  mutate(
    Typology = fct_relevel(primary_category, "urban", "green"),
    Positivity = datawizard::rescale(Positivity, to = c(1, 7), range = c(1, 9)),
    Excitement = datawizard::rescale(Excitement, to = c(1, 7), range = c(1, 9))
  )

# remove 2 participants that have 30 and 21 trials with video playback < video duration; 
# remove 1 trial from another participant with the same issue (but keep remaining trials).

df <- df %>% 
  filter(Buffering > 0, !(Participant %in% c("5fbb7aae04da87a3fe5f129c", "5d0cd09edff7d70019e6e045")))

df %>% 
   group_by(Participant) %>% tally() %>% arrange(n) %>% pull(n) %>% range(.)

df %>% 
   group_by(Video) %>% tally() %>% arrange(n) %>% summarise(mean(n), range(n), sd(n))

```




## Participant
Here we only provide an overview to confirm we have loaded the correct amount of participants -- as a sanity check. Participant characteristics are analysed and reported by a different file (Table 1).

```{r }
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, Age, Sex, Language, Crowd_Preference_Mean, starts_with("ipip"), SSA_Mean, SPS_Total_Mean, SIAS_Total_Mean, NSS, Upbringing_Environment, Current_Environment.y) |>
  slice(1)

nrow(dfsub)
```

A total of `r report::report_participants(dfsub, age="Age")` participants were included for analysis.

```{r }
(dfsub |>
  ggplot(aes(x = Age)) +
  geom_density(fill = "orange") +
  geom_vline(xintercept = mean(dfsub$Age), color = "red", linetype = "dashed") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_modern()) |
  (dfsub |>
    ggplot(aes(x = Sex, fill = Sex)) +
    geom_bar(stat = "count") +
    scale_y_continuous(expand = c(0, 0)) +
    scale_fill_see_d(guide = "none") +
    theme_modern())
```

# Correlation plot
```{r}
library(see)
library(correlation)

p_corrplot_u <- dfenv %>% 
  filter(Typology == "Urban") %>% 
  select(WLW = Willingness.to.walk, Crowdedness, Valence, Excitement, Restoration, Presence, Beauty, Interest, Structure, Width) %>%
  correlation(., bayesian = T) %>% 
  summary(redundant = FALSE) %>%
  plot() + scale_x_discrete(position = "top") + labs(title = "Urban spaces") +
  theme_modern()

p_corrplot_g <- dfenv %>% 
  filter(Typology == "Green") %>% 
  select(WLW = Willingness.to.walk, Crowdedness, Valence, Excitement, Restoration, Presence, Beauty, Interest, Structure, Width) %>%
  correlation(., bayesian = T) %>% 
  summary(redundant = FALSE) %>% 
  plot() + scale_x_discrete(position = "top") + labs(title = "Green spaces") +
  theme_modern()

p_corrplot_g


p_corr <- p_corrplot_u / p_corrplot_g + plot_annotation(title = "Correlation Matrix")
ggsave(p_corr, filename = "output/plots_corr.jpg", width = 13, height = 7, dpi = 300)


```

## Video Ratings {.tabset}

### Variable Distribution

```{r eval=FALSE, fig.height=fig.width*1.5, message=FALSE, warning=FALSE, cache=FALSE, include=FALSE}
p <- (plot_distributions(df, "Crowdedness") |
  plot_distributions(df, "Beauty")) /
  (plot_distributions(df, "Restoration") |
    plot_distributions(df, "Presence")) /
  (plot_distributions(df, "Attractiveness") |
    plot_distributions(df, "Structure")) /
  (plot_distributions(df, "Scenery") |
    plot_distributions(df, "Interest")) /
  (plot_distributions(df, "Width") |
    plot_distributions(df, "Familiarity")) /
  (plot_distributions(df, "Positivity") |
    plot_distributions(df, "Excitement"))
# p
# ggsave("figures/interindividualstimuli_variability.png", p, height=fig.width*1.5, width=fig.width, limitsize = FALSE, dpi=300)
```

## Determinants of Perceived Crowdedness

### Models
```{r}
rm(preds, params, mods, vars)
preds <- data.frame()
params <- data.frame()
mods <- list()
outcome_var <- "Crowdedness"
vars <- c("Beauty", "Scenery","Width", "Structure") # replaced familiarity with Beauty
i=1
for (i in 1:length(vars)) {
  var <- vars[i]
  print(var)

  f <- paste0(outcome_var, " ~ log1p(mean_pedcounts) * ", var, " * Typology + Familiarity  + (", var, "|Participant)")

  model <- glmmTMB::glmmTMB(as.formula(f), data = df)
  mods[[i]] <- model
  # Individual-level correlations
  # dfsub <- modelbased::estimate_grouplevel(model) |>
  #   modelbased::reshape_grouplevel() |>
  #   select(c(1, 3)) |>
  #   group_by(Participant) |>
  #   slice(1) |>
  #   datawizard::data_rename(pattern = paste0("Participant_Coefficient_", var),
  #               paste0(outcome_var, "_", var), regex = TRUE) |>
  #   merge(dfsub, by = "Participant")

  # Parameters
  param <- parameters::parameters(model, effects = "fixed")
  param$Variable <- var
  params <- rbind(params, param)

  # Predicted
  pred <- estimate_relation(model, at = c("mean_pedcounts", var, "Typology"), length = c(50, 7))
  names(pred)[names(pred) == var] <- "Value"
  pred$Variable <- var
  pred$Label <- paste0("Main effect: ", format_p(param$p[3]), "\nInteraction: ", format_p(param$p[4]))

  preds <- rbind(preds, pred)
}
```

### plots
```{r}
rm(p_crowd)
p_crowd <- preds |>
  filter(Predicted < 7) |>
  mutate(Value = as.factor(Value)) |>
  ggplot(aes(x = mean_pedcounts, y = Predicted)) +
  stat_density_2d(data = df, aes(y = Crowdedness, fill = ..density..), geom = "raster", contour = FALSE) +
  geom_line(aes(color = Typology, size = Value, group = interaction(Typology, Value))) +
  scale_fill_gradientn(colours = c("white", "grey"), guide = "none") +
  scale_size_manual(values = seq(from = .05, to = 2, length.out= 7), breaks= c(1:7)) +
  # scale_colour_viridis_b(option = "A") +
  # scale_x_log10(expand = c(0, 0), breaks = seq(2, 20, by = 2)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), breaks = c(0, 1, 3, 5, 7)) +
  labs(x = "Number of Pedestrians", y = "Perceived Crowdedness") +
  # coord_cartesian(ylim = c(1, 7)) +
  labs(alpha = "Rating", title = "Predictors of Crowdedness") +
  theme_modern(axis.title.space = 10) +
  theme(
    strip.placement = "outside",
    strip.text.x = element_text(hjust = 0, size = 12),
    axis.title.y = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggnewscale::new_scale_fill() +
  scale_color_manual(values = c("urban" = col_urban, "green" = col_green )) + # col_green
  scale_fill_manual(values = c("urban" = col_urban, "green" = col_green)) +
  ggside::geom_xsidedensity(data = df, aes(y = after_stat(scaled), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::geom_ysidedensity(data = df |>
    select(all_of(c("Typology", vars))) |>
    pivot_longer(-Typology, values_to = "Predicted", names_to = "Variable"), aes(x = after_stat(scaled), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::theme_ggside_void() +
  facet_wrap(~Variable, strip.position = "top", ncol = 2)

p_crowd
```

### tables

```{r}
# @PANOS: didn't touch that, need to re-adjust based on the new model
options("modelsummary_format_numeric_latex" = "plain")

names(mods) <- vars
modelsummary(mods, escape = FALSE,
  stars = TRUE, statistic = "[{conf.low} - {conf.high}]",
  coef_omit = "SD|Cor", 
  coef_rename = c(
    "log1p(mean_pedcounts)" = "Ped. Counts",
    "Typologygreen" = "Green",
    
    "StructureTypologygreen" = "Structure x Green",
    "BeautyTypologygreen" = "Beauty x Green",
    "WidthTypologygreen" = "Width x Green",
    "SceneryTypologygreen" = "Scenery x Green",
    
    "log1p(mean_pedcounts)Typologygreen"= "Ped. Counts x Green",
    "log1p(mean_pedcounts)Beauty" = "Ped. Counts x Beauty",
    "log1p(mean_pedcounts)Scenery" = "Ped. Counts x Scenery",
    "log1p(mean_pedcounts)Width" = "Ped. Counts x Width",
    "log1p(mean_pedcounts)Structure" = "Ped. Counts x Structure",

    "log1p(mean_pedcounts)SceneryTypologygreen" = "Ped. Counts x Scenery x Green",
    "log1p(mean_pedcounts)WidthTypologygreen" = "Ped. Counts x Width x Green",
    "log1p(mean_pedcounts)StructureTypologygreen" = "Ped. Counts x Structure x Green",
    "log1p(mean_pedcounts)BeautyTypologygreen" = "Ped. Counts x Beauty x Green"
  ),
  title = "Mixed effects models of Perceived Crowdedness \\label{tab:models_perceived_crowds}", 
  notes = "Ped. Counts : Log-transformed, average pedestrian count per stimulus",
  output = "output/table_models_perceived_crowds.tex"
)
```
 
## Determinants of Beauty

```{r}
rm(preds, mods, vars)
preds <- data.frame()
dat <- data.frame()
mods <- list()
vars <- c("Crowdedness", "Structure", "Scenery", "Width") #  "Interest",

for (i in 1:length(vars)) {
  var <- vars[i]
  print(var)

  f <- paste0("Beauty ~ poly(", var, ", 2) * Typology + Familiarity + (", var, "|Participant)")

  model <- glmmTMB::glmmTMB(as.formula(f), data = na.omit(df[c(var, "Beauty", "Typology", "Familiarity", "Participant")]))
  mods[[i]] <- model
  # Individual-level correlations
  # dfsub <- modelbased::estimate_grouplevel(model) |>
  #   modelbased::reshape_grouplevel() |>
  #   select(c(1, 3)) |>
  #   group_by(Participant) |>
  #   slice(1) |>
  #   data_rename(pattern = paste0("Participant_Coefficient_", var), paste0("Beauty_", var), regex = TRUE) |>
  #   merge(dfsub, by = "Participant")

  # Parameters
  param <- parameters::parameters(model, effects = "fixed")

  # Predicted
  pred <- estimate_relation(model, at = c(var, "Typology"), length = c(30))
  names(pred)[names(pred) == var] <- "Value"
  pred$Variable <- var
  pred$Label <- paste0(
    "Objective Crowding: ", format_p(param$p[2]),
    "\n", var, ": ", format_p(param$p[3]),
    "\nInteraction: ", format_p(param$p[4])
  )

  # Data for density
  dat <- rbind(dat, data.frame(Value = df[[var]], Predicted = df$Beauty, Variable = var))
  preds <- rbind(preds, pred)
}
```

### plots
```{r}
p_beauty <- preds |>
  ggplot(aes(x = Value, y = Predicted)) +
  stat_density_2d(data = dat, aes(fill = ..density..), geom = "raster", contour = FALSE) +
  geom_line(aes(color = Typology), size = 1) +
  scale_fill_gradientn(colours = c("white", "grey"), guide = "none") +
  scale_color_manual(values = c("urban" = col_urban, "green" = col_green)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(y = "Beauty", title = "Predictors of Beauty") +
  theme_modern(axis.title.space = 10) +
  theme(
    axis.title.x = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_text(hjust = 0.5, size = 12, face = "plain"),
    axis.title.y = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  ggnewscale::new_scale_fill() +
  scale_fill_manual(values = c("urban" = col_urban, "green" = col_green)) +
  ggside::geom_ysidedensity(data = mutate(df, Predicted = Beauty), aes(x = after_stat(scaled), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::geom_xsidedensity(data = df |>
    select(all_of(c("Typology", vars))) |>
    pivot_longer(-Typology, values_to = "Value", names_to = "Variable"), aes(y = after_stat(scaled), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::theme_ggside_void() +
  facet_wrap(~Variable, strip.position = "top", scales = "free_x")

p_beauty
```

### Tables
```{r}
names(mods) <- vars
modelsummary(mods, stars = TRUE)
modelsummary(mods, escape = FALSE,
  stars = TRUE, statistic = "std.error", #  "[{conf.low} - {conf.high}]",
  coef_omit = "SD|Cor",
  coef_rename = c(
                  "poly(Crowdedness, 2)1" = "Crowdedness",
                  "poly(Crowdedness, 2)2" = "Crowdedness<sup> 2</sup>",
                  "Typologygreen" = "Green",
                  "Familiarity"  = "Familiarity",
                  
                  "poly(Crowdedness, 2)1Typologygreen" = "Crowdedness x Green",
                  "poly(Crowdedness, 2)2Typologygreen" = "Crowdedness<sup> 2</sup> x Green",
                  
                  "poly(Structure, 2)1" = "Structure",
                  "poly(Structure, 2)2" = "Structure<sup> 2</sup>",
                  
                  "poly(Structure, 2)1Typologygreen" = "Structure x Green",
                  "poly(Structure, 2)2Typologygreen" = "Structure<sup> 2</sup> x Green",
                  
                  "poly(Scenery, 2)1" = "Scenery",
                  "poly(Scenery, 2)2" = "Scenery<sup> 2</sup>",
                  
                  "poly(Scenery, 2)1Typologygreen" = "Scenery x Green",
                  "poly(Scenery, 2)2Typologygreen" = "Scenery<sup> 2</sup> x Green",
                  
                  "poly(Width, 2)1Typologygreen" = "Width x Green",
                  "poly(Width, 2)2Typologygreen" = "Width<sup> 2</sup> x Green"
                  
                  ),
  title = "Non-linear mixed effects models of Perceived Beauty \\label{tab:models_beauty}",
  # notes = "PC (log) : Average pedestrian count per stimulus" ,
  output = "output/table_models_perceived_beauty.tex"
)


```

## Determinants of Psychological Reaction {.tabset}

```{r, warning=FALSE, message=FALSE}
rm(preds, dat, mods, vars)
preds <- data.frame()
dat <- data.frame()


mods <- list()
outcome_vars <- c("Attractiveness", "Positivity", "Excitement", "Restoration",  "Presence")

for (i in 1:length(outcome_vars)) {
  resp <- outcome_vars[i]
  print(resp)

  f <- paste(resp, " ~ Typology / (poly(Crowdedness, 2) * Beauty) + Familiarity + (1|Participant) + (1|Video)")

  model <- glmmTMB::glmmTMB(as.formula(f), data = na.omit(df[c(resp, "Beauty", "Typology", "Crowdedness", "Familiarity", "Participant", "Video")]))
  mods[[i]] <- model
  param <- parameters::parameters(model, effects = "fixed")

  # Predictions
  preds <- estimate_relation(model, at = c("Typology", "Crowdedness", "Beauty"), length = c(50, 7)) |>
    mutate(Outcome = resp) |>
    rbind(preds)

  # Data for density
  dat <- rbind(
    dat,
    data.frame(
      Typology = df$Typology,
      Crowdedness = df$Crowdedness,
      mean_pedcounts = df$mean_pedcounts,
      Predicted = df[[resp]],
      Outcome = resp
    )
  )

  # Random (simplified model)
  f <- paste(resp, " ~ mean_pedcounts + Beauty + (mean_pedcounts + Beauty |Participant)")
  model <- glmmTMB::glmmTMB(as.formula(f), data = df)
  # dfsub <- modelbased::estimate_grouplevel(model) |>
  #   modelbased::reshape_grouplevel(indices = "Coefficient") |>
  #   select(c(1, 3, 4)) |>
  #   group_by(Participant) |>
  #   slice(1) |>
  #   data_addprefix(paste0(resp, "_"), exclude = "Participant") |>
  #   merge(dfsub, by = "Participant")
}



names(mods) <- c("Willingness to Walk", "Positivity", "Excitement", "Restoration",  "Presence")
```

### plots psych
```{r, warning=FALSE, message=FALSE}

dat$Outcome <- recode(dat$Outcome, "Attractiveness"="Willing.-to-walk")

p_psych <- preds |>
  dplyr::filter(Predicted <= 7) |>
  mutate(Beauty = fct_rev(as.factor(Beauty)),
         Outcome = recode_factor(Outcome, "Attractiveness"="Willing.-to-walk"),
         Outcome = fct_relevel(Outcome, c("Willing.-to-walk", "Positivity", "Excitement", "Restoration", "Interest", "Presence"))) |>
  ggplot(aes(x = Crowdedness, y = Predicted)) +
  stat_density_2d(data = dat, aes(fill = ..density..), geom = "raster", contour = FALSE) +
  geom_line(aes(size = Beauty, color = Typology, group = interaction(Beauty, Typology))) +
  scale_size_manual(values = seq(from = .05, to = 2, length.out= 7), breaks= c(1:7)) +
  scale_fill_gradientn(colours = c("white", "grey"), guide = "none") +
  scale_color_manual(values = c("urban" = col_urban, "green" = col_green)) +
  scale_alpha_ordinal(range = c(1, 0.1)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), breaks = c(1:7)) +
  theme_modern(axis.title.space = 10) +
  theme(
    strip.placement = "outside",
    strip.text.x = element_text(hjust = 0, size = 12),
    axis.title.y = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  labs(x = "Subjective Crowdedness", y = "Psychological Outcome", title = "Psychological effect of Crowdedness and its modulation by Beauty") +
  ggnewscale::new_scale_fill() +
  scale_fill_manual(values = c("urban" = col_urban, "green" = col_green)) +
  ggside::geom_xsidedensity(data=dat, aes(y=stat(density), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::geom_ysidedensity(data=dat, aes(x=stat(density), fill = Typology), color = NA, alpha = 0.5, adjust = 2) +
  ggside::theme_ggside_void() +
  facet_wrap(~Outcome, strip.position = "left", scales = "free")

p_psych

```


### Table output
```{r}
modelsummary(mods, stars = TRUE)
modelsummary(mods,
  stars = TRUE, statistic = "[{conf.low} - {conf.high}]", escape = FALSE,
  coef_omit = "SD|Cor", 
  coef_rename = c("Typologygreen"="Green",
                  "Familiarity"  = "Familiarity",
                  "Typologyurbanpoly(Crowdedness, 2)1"="Urban * Crowdedness",
                  "Typologygreenpoly(Crowdedness, 2)1"="Green * Crowdedness",
                  "Typologyurbanpoly(Crowdedness, 2)2"="Urban * Crowdedness<sup> 2</sup>",
                  "Typologygreenpoly(Crowdedness, 2)2"="Green * Crowdedness<sup> 2</sup>",
                  "TypologyurbanBeauty" = "Urban * Beauty",
                  "TypologygreenBeauty" = "Green * Beauty",
                  "Typologyurbanpoly(Crowdedness, 2)1Beauty" = "Urban * Crowdedness * Beauty",
                  "Typologygreenpoly(Crowdedness, 2)1Beauty" = "Green * Crowdedness * Beauty",
                  "Typologyurbanpoly(Crowdedness, 2)2Beauty" = "Urban * Crowdedness<sup> 2</sup> * Beauty",
                  "Typologygreenpoly(Crowdedness, 2)2Beauty" = "Green * Crowdedness<sup> 2</sup> * Beauty"
                  ),
  title = "Non-linear mixed effects models of psychological reaction\\label{tab:models_reaction}",
  # notes = "PC (log) : Average pedestrian count per stimulus" ,
  output = "output/table_models_psych_reaction.tex"
)
```
## joint plots
```{r}

p_reg <- ((p_crowd + guides(fill = "none", color = "none") | p_beauty + theme(legend.position = "none")) / p_psych + theme(legend.position = 'bottom') )  +plot_annotation(tag_levels = "A")

p_reg

ggsave(p_reg, filename = "output/plots_reg.jpg", width = 13, height = 13, dpi = 300)
```


```{r}
dfenv <- df %>% 
  group_by(name_df_keep, Typology) %>% 
  summarise_at(.vars = c( "Restoration", "Attractiveness","Presence", "Width", "Structure", "Beauty","Interest", "Scenery", "Familiarity",  "Positivity","Excitement", "Crowdedness" ), .funs = function(x) mean(x, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(Typology = recode_factor(Typology, "urban" = "Urban", "green" = "Green" )) %>% 
  rename(`Willingness to walk` = Attractiveness, 
         Valence = Positivity)

```


```{r}
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        # p <- t.test(y ~ g)$p.value
        p <- BayesFactor::ttestBF(x=y, y= g)
        p <- p@bayesFactor$bf
            # print(p)
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
```


```{r}
t1 <- table1::table1(~ Valence + Excitement + Restoration + Beauty + `Willingness to walk` + Interest + Familiarity + Structure + Presence  + Crowdedness  | Typology, overall = F,
    data=dfenv, extra.col=list(`BF`=pvalue))

t1 %>% 
  data.frame() %>% 
  filter(str_detect(X. , "Median", negate = T)) %>% 
  rename(" " = "X.") %>% 
  kbl(., format = "latex", escape = T, booktabs = T, 
      label = "stimuli_descriptives", 
        caption = "Descriptive statistics of emotional reaction and environmental appraisals for stimuli, split by typology") %>% 
  row_spec(seq(2, 20, 2), bold=T) %>% 
  add_indent(seq(3, 21, 2), ) %>% 
  footnote(number  = "Bayesian t-tests; reporting the bayes factor.") %>% 
  save_kable(file = "output/stimuli_table1.tex", )


```

```{r}
library(ggdist)

penv <- dfenv %>% 
  pivot_longer(Restoration : Crowdedness) %>% 
  ggplot(aes(x = name, y = value, colour = Typology)) +
  # geom_boxplot( position = position_dodge()) +
  # geom_line(aes(group = name_df_keep),  alpha =.2)+
  geom_jitter(position = position_jitterdodge(), alpha = 0.5) +
  ggdist::stat_halfeye(position = position_dodge(), aes(fill = Typology),
    ## custom bandwidth
    adjust = .5,
    ## adjust height
    width = .6,
    ## move geom to the right
    justification = -.4,
    ## remove slab interval
    .width = 0,
  point_colour = NA) +
  scale_color_manual(values = c("Urban" = col_urban, "Green" = col_green)) +
  scale_fill_manual(values = c("Urban" = col_urban, "Green" = col_green)) +
  theme_classic() +
  # gghalves
  labs(y = "Rating", x = "Dimension")

penv
ggsave(penv, filename = "output/plots_envstats.jpg", width = 13, height = 13/2, dpi = 300)

```

```{r}
library(see) # for plotting
library(ggraph) # needs to be loaded

names(dfenv) <- make.names(names(dfenv))
cor_urb <- dfenv %>% 
  filter(Typology == "Urban") %>% 
  ungroup() %>% 
  select(Willingness.to.walk, Restoration, Interest, Valence, Excitement, Crowdedness, Scenery, Width ) %>% 
  correlation(partial = TRUE, standardize_names = F) %>% 
  filter(p < 0.01) %>%
  plot()
cor_urb

cor_green <- dfenv %>% 
  filter(Typology == "Green") %>% 
  ungroup() %>% 
  select(Willingness.to.walk, Restoration, Interest, Valence, Excitement, Crowdedness, Scenery, Width ) %>% 
  correlation(partial = TRUE) %>% 
  # filter(p < 0.01) %>% 
  plot()
cor_green
```

## Pics

```{r}

dfenv %>% 
  ggplot(aes(Crowdedness,Beauty,  colour = Typology)) +
  geom_jitter(alpha = 0.5, position = position_jitterdodge(jitter.height = .3, jitter.width = .3))+ 
  geom_smooth(method = "gam" ) 
  scale_color_manual(values = c("urban" = col_urban, "green" = col_green)) 

dfenv %>% 
  group_by(Typology) %>% 
  arrange(Beauty) %>% 
  slice(1:5, (n()-5): n()) %>% 
  select(name_df_keep, Beauty)


```

```{r}

library(kableExtra)

df %>% 
  select(Restoration:Excitement) %>% 
  datasummary(All(.) ~  (`Unique (#)` = N) + (`Missing (%)` = PercentMissing) + Mean + SD, data =., 
              output = "latex_tabular", title = "Descriptive statistics of responses to the stimuli", 
              label = "response_descriptives")  %>% 
    save_kable(file = "output/response_descriptives.tex")
  
df %>% 
  group_by(Participant) %>% 
  tally() %>% 
  mutate(n = 30 -n) %>% 
  filter(n> 0) %>% 
  mutate(sum(n))

df %>% 
  filter(Video_Time < 30) %>% 
  select(videoname, Video_Time)

```


## Session information
```{r}
sessionInfo()
```
